<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>留言板</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/jquery-1.11.2.js"></script>
    <script src="js/mock-min.js"></script>
    <script src="mock/login.js"></script>
    <script src="mock/message.js"></script>
    <script src="js/public.js"></script>
    <script>
        $(function(){
        
            $("#btn3").click(function(){
                $.ajax({
                    url:"check.php",
                    type:"POST",
                    contentType:"application/json",
                    data:JSON.stringify({userName:$("#userName").val(),pwd:$("#pwd").val()}),
                    dataType:"json",
                    success:function(data){
                        if(data.status=="10001"){
                            location.href="会员登录成功.html";
                        }else{
                            $("#tips1").html(data.msg);
                        }
                        if(data.status=="110"){
                            location.href="管理员登录成功.html"
                        }
                    }
                })
                if($("#sryzm").text!=$("#yzm").text()){
                    $("#tips2").text("验证码错误！");
                }
            });
            //点击登录按钮 进行验证
            $("#btn3").click(function(){
                $.ajax({
                    url:"check.php?action='login'",
                    type:"POST",
                    data:{userName:$("#userName").val(),pwd:$("#pwd").val()},
                    dataType:"json",
                    success:function(){
                        //验证成功，将jwt-token持久化到localStorage中
                        if(data.result=="success"){
                            localStorage.setItem("jwt",data.jwt);
                            location.href="会员登陆成功.html";
                        }else{
                            $("#tips1").text(data.msg);
                        }
                    }
                })
            });
            //如果jwt不是空，则发送给接口进行验证
            var jwt=localStorage.getItem("jwt");
            if(!!jwt){
                $.ajax({
                    url:"check.php",
                    type:"GET",
                    headers:{
                        "X-token":localStorage.getItem("jwt")
                    },
                    dataType:"json",
                    success:function(){
                        //验证通过，从负载中取出数据
                        if(data.result=="success"){
                            location.href="会员登陆成功.html";
                        }else{
                            $("#tips1").text(data.msg);
                        }
                    }
                });

                $("#userName").focus(function(){
                    $("#tips1").text("");
                });
                $("#pwd").focus(function(){
                    $("#tips1").text("");
                })
            }
        
            
            //页面初始化，显示已审核过的留言
            $.ajax({
                url:"data.php",
                type:"POST",
                dataType:"json",
                success:function(data){
                    console.log("data",data);
                    data=data.data;
                    var str=" ";
                        for(var i=0;i<data.length;i++){
                            if(data[i].shenhe==1){
                                str+="<tr class=tr_content><td>"
                                    +data[i].name+"<br>"
                                    +" "+data[i].date+"<br>"
                                    +" "+data[i].content+"<br>"
                                    +" "+(data[i].reply!=null ? ('管理员回复:'+data[i].reply) :(" "))+"</td></tr>"
                            } 
                            }  
                    $("#t_content").html(str);
                }
            })
        })
    </script>
</head>
<body class="index">
    <div id="container">
        <header>
            <div id="sous">
                <div class="p1"><img src="images/sou.png"></div>
                <input type="text" placeholder="搜索留言">
                <button><span>搜索</span></button>
            </div>
        </header>
        <div id="left">
           <ul>
               <li><a href="#">浏览留言</a></li>
               <li><a href="#">发布留言</a></li>
           </ul>
        </div>
        
        <div id="content">
            <table id="t_content">
                
            </table>
        </div>
        <div id="right">
            <section>
                <div class="text"></div>
                <button id="btn2"><span>立即登录</span></button>
                <div class="reg">还没有会员？<a href="注册.html">立即注册！</a></div>
            </section>
        </div>
    </div>
    <div id="mask" style="display: none;">
        <div id="login">
            <img id="x" src="./images/x.png">
            <div>     
                <label for="userName">用户名</label>
                <input type="text" id="userName" name="userName" autocomplete="off"><br>
                <label for="pwd">密码</label>
                <input type="password" id="pwd" name="pwd" autocomplete="off"><br>
                <span id="tips1"></span>
                <input type="text" id="sryzm" placeholder="请输入" autocomplete="off">
                <canvas id="yzm" width="150" height="50"></canvas>
                <span id="tips2"></span>
                <br>
                <input type="button" id="btn3" value="登录">
            </div>
        </div>
    </div>
</body>
</html>